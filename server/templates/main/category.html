{% extends '../base2.html' %} {% load static %}
{%block page%}
<main class="group-category">
    <div id="category-content">
        <div id="category-container">
            <button onclick="create_category();">카테고리 추가</button>
            <div id="create_category" class="displayNone">
                <form onsubmit="add_category(event)">
                    {% csrf_token %}                        <input type="text" placeholder="카테고리 이름을 입력하세요." id="name" name="name">
                    <div id="error-message-category" style="color: red;"></div>
                    <button type="submit">생성</button>
                </form>
            </div>
            <div id="category-not-finish-list">
                <h2>완료되지 않은 카테고리 목록</h2>
                <div id="category-not-finish-for">
                    {% for category in not_finish_categorys %}
                    <div class="category-item" id="nf-category-{{category.pk}}" onclick="click_category({{category.pk}}, 'unfinish')">
                        <h2 id="tag-{{category.pk}}">{{category.name}}</h2>
                        <!-- <button onclick="update_btn({{category.pk}});">수정</button>
                        <button onclick="delete_category({{category.pk}});">삭제</button>
                        <button onclick="complete_category({{category.pk}});">완료</button> -->
                    </div>
                    {% endfor %}
                </div>
                
            </div>
            <div id="category-finish-list">
                <h2>완료된 카테고리 목록</h2>
                <div id="category-finish-for">
                    {% for category in finish_categorys %}
                    <div class="category-item" id="f-category-{{category.pk}}" onclick="click_category({{category.pk}}, 'finish')">
                        <h2 id="tag-{{category.pk}}">{{category.name}}</h2>
                        <!-- <h2>{{category.memory}}</h2> -->
                    </div>
                    {% endfor %}
                </div>
            </div>
            
        </div>
        <div id="category-detail-container">

            <!-- <div id="cdc-name-box">
                <h2 id="cdc-name-{{category.pk}}">{{selected_category.name}}</h2>
                <button onclick="update_btn({{category.pk}});">닉네임 수정</button>
            </div>
            <div id="cdc-memory-box">
                <h2>memory</h2>
                <textarea name="memory" id="category-memory" cols="40" rows="10">{{selected_category.memory}}</textarea>
                <button onclick="update_memory({{category.pk}});">memory 수정</button>
            </div>
            <div id="cdc-finish-box">
                <label>
                    <input type="checkbox" name="finish_check" value="finish_check" onchange="updateProfile(this)" {% if selected_category.finish %}checked{% endif %}/>
                    완료 여부
                </label>
            </div> -->
            
        </div>
    </div>
    
    
</main>

<!-- <div class="todo-checkbox todo-checkbox-${todo.id} ${todo.goal_check}" onclick="check_todo(${todo.id})"></div> -->
{% endblock %}

{% block extra %}
<script>
    const create_category = () => {
        const createInput = document.querySelector('#create_category');
        createInput.classList.remove('displayNone');
    };

    const add_category = async (event) =>{
        event.preventDefault();

        const formData = new FormData(event.target);

        const nameInput = document.querySelector('#name');
        nameInput.value = '';

        const url = "/main/create_category/";
        const res = await fetch(url, {
            method:"POST",
            headers:{},
            body: formData,
        });
        const {success, category_data, error_text}=await res.json();
        category_add(success, category_data, error_text);
    }
    const category_add = (success, category_data, error_text) => {
        const createInput = document.querySelector('#create_category');
        const errorMessageElement = document.querySelector('#error-message-category');

        errorMessageElement.textContent = ''; // 오류 메시지 초기화
        
        if(success){
            createInput.classList.add('displayNone');
            const categoryInput = document.querySelector('#category-not-finish-for');
            const divInput=document.createElement('div');
            divInput.classList.add('category-item');
            divInput.setAttribute('id', 'nf-category-'+category_data.pk);
            divInput.setAttribute('onclick', `click_category(${category_data.pk}, 'unfinish')`);
            divInput.innerHTML=`
            <h2 id="tag-${category_data.pk}">${category_data.name}</h2>
            `;
            categoryInput.insertBefore(divInput, categoryInput.firstChild);
        }else{
            errorMessageElement.textContent=error_text;
        }
    }

    const update_btn = (pk) => {
        const h2Input = document.querySelector('#cdc-name-'+pk);
        const tmpname = h2Input.textContent;
        const categoryBox = document.querySelector('#cdc-name-box');

        const inputElement = document.createElement('input');
        inputElement.setAttribute('type', 'text');
        inputElement.setAttribute('value', tmpname);
        inputElement.setAttribute('id', 'update_name-'+pk);
        inputElement.setAttribute('name', 'name');

        h2Input.remove();

        categoryBox.insertBefore(inputElement, categoryBox.firstChild);
        inputElement.focus();

        inputElement.addEventListener('blur', ()=>{
            const updatedName = inputElement.value;
            const update_pk = inputElement.id.slice("update_name-".length);   // update_name-{pk} 에서 마지막에 위치한 pk를 가져옴

            update_category(updatedName, update_pk);
        });
    };
    
    const update_category = async (name, pk) =>{

        const formData = new FormData();
        formData.append('name', name);
        formData.append('pk', pk);

        const url = "/main/update_category/";
        const res = await fetch(url, {
            method:"POST",
            headers:{},
            body: formData,
        });
        const {error_text, origin_name}=await res.json();
        category_update(error_text, origin_name, name, pk);
    }
    const category_update = (error_text, origin_name, name, pk) => {
        const categoryBox = document.querySelector('#cdc-name-box');
        const inputElement = document.querySelector('#update_name-'+pk);
        inputElement.remove();

        const h2Element = document.createElement('h2');
        h2Element.setAttribute('id', 'cdc-name-'+pk);

        if(error_text==""){
            h2Element.textContent=name;
            const listItem = document.querySelector('#tag-'+pk);
            listItem.textContent=name;
        }            
        else
            h2Element.textContent=origin_name;

        categoryBox.insertBefore(h2Element, categoryBox.firstChild);

    }

    const delete_category = async (pk, type) =>{

        const formData = new FormData();
        formData.append('pk', pk);

        const url = "/main/delete_category/";
        const res = await fetch(url, {
            method:"POST",
            headers:{},
            body: formData,
        });
        const {success}=await res.json();
        category_delete(pk, type);
    }
    const category_delete = (pk, type) => {
        const categoryBox = document.querySelector('#category-detail-container');
        categoryBox.innerHTML=`
            <h2>성공적으로 삭제되었습닌다.</h2>
        `;
        let select_str="";
        if(type=="finish"){
            select_str="#f-category-";
        }else if(type=="unfinish"){
            select_str="#nf-category-";
        }
        const listItem = document.querySelector(select_str+pk);
        listItem.remove();

    }

    const update_finish = async (checkBox, pk) =>{

        const formData = new FormData();
        formData.append('isChecked', checkBox.checked);
        formData.append('pk', pk);

        const url = "/main/finish_category/";
        const res = await fetch(url, {
            method:"POST",
            headers:{},
            body: formData,
        });
        const {success, name}=await res.json();
        finish_update(checkBox.checked, name, pk);
    }
    const finish_update = (isChecked, name, pk) => {
        let categoryInput;
        
        const divInput=document.createElement('div');
        divInput.classList.add('category-item');
        if(isChecked==true){
            const listItem = document.querySelector('#nf-category-'+pk);
            listItem.remove();
            categoryInput = document.querySelector('#category-finish-for');
            divInput.setAttribute('id', 'f-category-'+pk);
            divInput.setAttribute('onclick', `click_category(${pk}, 'finish')`);
        }else{
            const listItem = document.querySelector('#f-category-'+pk);
            listItem.remove();
            categoryInput = document.querySelector('#category-not-finish-for');
            divInput.setAttribute('id', 'nf-category-'+pk);
            divInput.setAttribute('onclick', `click_category(${pk}, 'unfinish')`);
        }
        divInput.innerHTML=`
        <h2 id="tag-${pk}">${name}</h2>
        `;
        categoryInput.insertBefore(divInput, categoryInput.firstChild);
    }


    const click_category = async (pk, type) =>{

        const formData = new FormData();
        formData.append('pk', pk);
        formData.append('type', type);

        const url = "/main/click_category/";
        const res = await fetch(url, {
            method:"POST",
            headers:{},
            body: formData,
        });
        const {category_data}=await res.json();
        show_category(category_data, pk, type);
    }
    const show_category = (category_data, pk, type) => {
        const categoryBox = document.querySelector('#category-detail-container');
        
        if(type=="finish"){
            categoryBox.innerHTML=`
            <div id="cdc-name-box">
                <h2 id="cdc-name-${pk}">${category_data.name}</h2>
                <button onclick="update_btn(${pk});">닉네임 수정</button>
            </div>
            <div id="cdc-memory-box">
                <h2>memory</h2>
                <textarea name="memory" id="category-memory" cols="40" rows="10">${category_data.memory}</textarea>
                <button onclick="update_memory(${pk});">memory 수정</button>
            </div>
            <div id="cdc-finish-box">
                <label>
                    <input type="checkbox" name="finish_check" value="finish_check" onchange="update_finish(this, ${pk})" checked/>
                    완료 여부
                </label>
            </div>
            <div id="cdc-delete-box">
                <button onclick="delete_category(${pk}, 'finish');">삭제</button>
            </div>
            `;
        }else if(type=="unfinish"){
            categoryBox.innerHTML=`
            <div id="cdc-name-box">
                <h2 id="cdc-name-${pk}">${category_data.name}</h2>
                <button onclick="update_btn(${pk});">닉네임 수정</button>
            </div>
            <div id="cdc-memory-box">
                <h2>memory</h2>
                <textarea name="memory" id="category-memory" cols="40" rows="10">${category_data.memory}</textarea>
                <button onclick="update_memory(${pk});">memory 수정</button>
            </div>
            <div id="cdc-finish-box">
                <label>
                    <input type="checkbox" name="finish_check" value="finish_check" onchange="update_finish(this, ${pk})"/>
                    완료 여부
                </label>
            </div>
            <div id="cdc-delete-box">
                <button onclick="delete_category(${pk}, 'unfinish');">삭제</button>
            </div>
            `;
        }
    }

</script>
{% endblock %}